<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق التداول AI (v22.0)</title>
    
    <!-- 1. استيراد مكتبات الذكاء الاصطناعي والمؤشرات -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/technicalindicators@3.1.0/dist/browser.js"></script>

    <link id="manifest-link" rel="manifest">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg-color: #131722; --card-color: #1e222d; --text-color: #d1d4dc; --primary-color: #2962ff; --ai-color: #9c27b0; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-color ); color: var(--text-color); margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 800px; margin: auto; }
        .card { background-color: var(--card-color); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .hidden { display: none; }
        #installer { text-align: center; }
        #progress-bar-container { width: 100%; background-color: #333; border-radius: 5px; margin: 15px 0; }
        #progress-bar { width: 0%; height: 25px; background-color: var(--ai-color); border-radius: 5px; transition: width 0.3s; text-align: center; line-height: 25px; }
        #progress-details { font-size: 0.9rem; color: #aaa; }
        .btn { padding: 10px 20px; font-size: 1rem; background-color: var(--primary-color); border: none; border-radius: 6px; color: white; cursor: pointer; margin: 5px; }
        .btn:disabled { background-color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <header style="text-align: center; margin-bottom: 20px;">
            <h1>تطبيق التداول AI (v22.0)</h1>
            <p>يستخدم الذكاء الاصطناعي للتعلم والتنبؤ بالفرص</p>
        </header>

        <div id="installer" class="card">
            <h2>جاري إعداد العقل الاصطناعي...</h2>
            <p>هذه العملية تحدث مرة واحدة فقط وقد تستغرق بضع دقائق.</p>
            <div id="progress-bar-container"><div id="progress-bar">0%</div></div>
            <p id="progress-details">الخطوة 1/3: تحميل البيانات التاريخية...</p>
        </div>

        <div id="app" class="card hidden">
            <h2>النموذج جاهز ويعمل</h2>
            <p>التطبيق الآن يستخدم نموذجا مدرباً لتحليل السوق في الخلفية.</p>
            <button id="notify-btn" class="btn">1. طلب إذن الإشعارات</button>
            <button id="sync-btn" class="btn" disabled>2. تشغيل التنبؤ الآن (للتجربة)</button>
            <p id="app-status" style="margin-top: 15px;">الحالة: في انتظار الأوامر...</p>
        </div>
    </div>

    <script>
        // --- الجزء الأول: منطق الواجهة (app.js سابقاً) ---
        const installerDiv = document.getElementById('installer');
        const appDiv = document.getElementById('app');
        const progressBar = document.getElementById('progress-bar');
        const progressDetails = document.getElementById('progress-details');
        const notifyBtn = document.getElementById('notify-btn');
        const syncBtn = document.getElementById('sync-btn');
        const appStatus = document.getElementById('app-status');

        // --- الجزء الثاني: كود الـ Service Worker المضمن ---
        const serviceWorkerCode = `
            importScripts('https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js' );
            importScripts('https://cdn.jsdelivr.net/npm/technicalindicators@3.1.0/dist/browser.js' );

            const MODEL_DB_NAME = 'trading-ai-model';
            const MODEL_STORE_NAME = 'model-store';
            const MODEL_KEY = 'btc-4h-model';

            self.addEventListener('install', e => self.skipWaiting());
            self.addEventListener('activate', e => self.clients.claim());

            self.addEventListener('message', async (event) => {
                if (event.data.type === 'train') {
                    console.log('SW: تلقى أمر التدريب...');
                    await trainAndSaveModel(event.data.klines);
                    event.source.postMessage({ type: 'training_complete' });
                } else if (event.data.type === 'predict') {
                    console.log('SW: تلقى أمر التنبؤ...');
                    await performPrediction();
                }
            });

            // --- 1. التدريب وحفظ النموذج ---
            async function trainAndSaveModel(klines) {
                console.log('SW: بدء معالجة البيانات للتدريب...');
                const { features, labels } = createTrainingData(klines);
                const [X, Y] = [tf.tensor2d(features), tf.tensor2d(labels)];

                console.log('SW: بدء تدريب النموذج...');
                const model = createModel(features[0].length);
                await model.fit(X, Y, {
                    epochs: 20,
                    batchSize: 32,
                    shuffle: true,
                    callbacks: { onEpochEnd: (epoch, logs) => console.log(\`Epoch \${epoch + 1}: loss = \${logs.loss.toFixed(4)}\`) }
                });

                console.log('SW: تم الانتهاء من التدريب. جاري حفظ النموذج...');
                await model.save(\`indexeddb://\${MODEL_KEY}\`);
                console.log('SW: تم حفظ النموذج في IndexedDB.');
            }

            // --- 2. التنبؤ باستخدام النموذج المحفوظ ---
            async function performPrediction() {
                try {
                    console.log('SW: تحميل النموذج من IndexedDB...');
                    const model = await tf.loadLayersModel(\`indexeddb://\${MODEL_KEY}\`);
                    
                    console.log('SW: جلب أحدث البيانات للتنبؤ...');
                    const klines = await getHistoricalData('BTCUSDT', '4h', 100);
                    const latestFeatures = getFeaturesForPrediction(klines);
                    const predictionTensor = model.predict(tf.tensor2d([latestFeatures]));
                    const prediction = await predictionTensor.data();
                    
                    const confidence = prediction[0] * 100;
                    console.log(\`SW: نتيجة التنبؤ: \${confidence.toFixed(2)}%\`);

                    if (confidence > 70) { // عتبة الثقة
                        const title = \`فرصة شراء محتملة (ثقة \${confidence.toFixed(0)}%)\`;
                        const options = { body: 'نموذج الذكاء الاصطناعي يتوقع حركة صعودية لـ BTCUSDT.' };
                        await self.registration.showNotification(title, options);
                    }
                } catch (error) {
                    console.error('SW: فشل التنبؤ:', error);
                    await self.registration.showNotification('خطأ في التنبؤ', { body: 'لم يتم العثور على نموذج مدرب. يرجى إعادة تثبيت التطبيق.' });
                }
            }
            
            // --- 3. دوال مساعدة للتعلم الآلي ---
            function createModel(inputShape) {
                const model = tf.sequential();
                model.add(tf.layers.dense({ inputShape: [inputShape], units: 32, activation: 'relu' }));
                model.add(tf.layers.dense({ units: 16, activation: 'relu' }));
                model.add(tf.layers.dense({ units: 1, activation: 'sigmoid' })); // Sigmoid for probability output (0 to 1)
                model.compile({ optimizer: 'adam', loss: 'binaryCrossentropy' });
                return model;
            }

            function createTrainingData(klines) {
                const features = [];
                const labels = [];
                const lookahead = 5; // نتنبأ بما إذا كان السعر سيرتفع بعد 5 شمعات

                for (let i = 50; i < klines.length - lookahead; i++) {
                    const featureSet = getFeaturesForPrediction(klines.slice(0, i + 1));
                    features.push(featureSet);

                    const futurePrice = klines[i + lookahead].close;
                    const currentPrice = klines[i].close;
                    labels.push([futurePrice > currentPrice ? 1 : 0]); // 1 for up, 0 for down
                }
                return { features, labels };
            }

            function getFeaturesForPrediction(klines) {
                const closes = klines.map(k => k.close);
                const rsi = technicalindicators.rsi({ values: closes, period: 14 });
                const macd = technicalindicators.macd({ values: closes, fastPeriod: 12, slowPeriod: 26, signalPeriod: 9 });
                const stc = technicalindicators.stc({values: closes, fastPeriod:12, slowPeriod:26, kPeriod:10, dPeriod:3, signalPeriod:3});

                return [
                    rsi.slice(-1)[0] / 100, // Normalize
                    macd.slice(-1)[0].MACD / closes.slice(-1)[0], // Normalize
                    stc.slice(-1)[0] / 100 // Normalize
                ];
            }

            async function getHistoricalData(symbol, interval, limit) { const url = \`https://api.binance.com/api/v3/klines?symbol=\${symbol}&interval=\${interval}&limit=\${limit}\`; const response = await fetch(url ); if (!response.ok) throw new Error(\`Failed to fetch \${interval} data.\`); const data = await response.json(); return data.map(k => ({ close: parseFloat(k[4]) })); }
        `;

        // --- الجزء الثالث: دمج كل شيء ---
        document.addEventListener('DOMContentLoaded', () => {
            // ... (كود إنشاء Manifest المضمن كما في السابق) ...
            const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="#9c27b0" d="M50 10L61.2 35.4H88.8L68.8 51.2L79.4 76.6L50 60.8L20.6 76.6L31.2 51.2L11.2 35.4H38.8z"/></svg>`;
            const manifest = { name: "تطبيق التداول AI", short_name: "AI Trade", start_url: ".", display: "standalone", background_color: "#131722", theme_color: "#1e222d", icons: [{ src: `data:image/svg+xml;base64,${btoa(svgIcon )}`, sizes: "192x192 512x512", type: "image/svg+xml" }] };
            document.getElementById('manifest-link').href = `data:application/json;base64,${btoa(JSON.stringify(manifest))}`;

            // تسجيل الـ Service Worker
            if ('serviceWorker' in navigator) {
                const blob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swURL)
                    .then(reg => {
                        console.log('AI Service Worker مسجل.');
                        if (!localStorage.getItem('ai_app_installed_v22')) runInstallation(reg);
                        else showApp();
                    }).catch(err => console.log('فشل تسجيل AI SW:', err));
            }
        });

        async function runInstallation(registration) {
            let progress = 0;
            
            // 1. تحميل البيانات
            updateProgress(progress, "الخطوة 1/3: تحميل البيانات التاريخية للتدريب...");
            const klines = await fetch(`https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=4h&limit=1000` ).then(res => res.json());
            progress = 33;
            updateProgress(progress, "الخطوة 2/3: تدريب النموذج (قد يستغرق وقتاً)...");

            // 2. إرسال أمر التدريب إلى SW
            navigator.serviceWorker.controller.postMessage({ type: 'train', klines: klines.map(k => ({ close: parseFloat(k[4]) })) });

            // 3. انتظار اكتمال التدريب
            const trainingPromise = new Promise(resolve => {
                navigator.serviceWorker.onmessage = (event) => {
                    if (event.data.type === 'training_complete') {
                        resolve();
                    }
                };
            });
            await trainingPromise;
            
            progress = 100;
            updateProgress(progress, "اكتمل التدريب! تم حفظ النموذج.");
            localStorage.setItem('ai_app_installed_v22', 'true');
            setTimeout(showApp, 1000);
        }

        function updateProgress(p, details) {
            progressBar.style.width = `${p}%`;
            progressBar.textContent = `${p}%`;
            progressDetails.textContent = details;
        }

        function showApp() { installerDiv.classList.add('hidden'); appDiv.classList.remove('hidden'); }
        notifyBtn.addEventListener('click', () => { Notification.requestPermission().then(p => { if (p === 'granted') { appStatus.textContent = "تم منح إذن الإشعارات."; notifyBtn.disabled = true; syncBtn.disabled = false; } }); });
        syncBtn.addEventListener('click', () => { if (navigator.serviceWorker.controller) { appStatus.textContent = "تم إرسال أمر التنبؤ إلى الخلفية..."; navigator.serviceWorker.controller.postMessage({ type: 'predict' }); } });
    </script>
</body>
</html>
